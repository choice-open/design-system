{
  "slug": "layouts/panel/sortable",
  "title": "Sortable",
  "package": {
    "name": "@choice-ui/panel",
    "version": "0.0.6",
    "description": "A panel component for organizing content in collapsible sections with headers and actions",
    "dependencies": {
      "usehooks-ts": "^3.1.0",
      "@choice-ui/shared": "workspace:*",
      "@choiceform/icons-react": "^1.3.8"
    },
    "peerDependencies": {
      "react": ">=18.0.0",
      "react-dom": ">=18.0.0"
    }
  },
  "exports": [
    "PanelBase",
    "Panel",
    "type PanelRowProps",
    "PanelRow",
    "PanelLabel",
    "PanelTitle",
    "PanelSortable",
    "PanelSortableRow",
    "PanelRowLabel",
    "type PanelRowManyIconItem",
    "type PanelRowManyIconProps",
    "PanelRowManyIcon",
    "PanelPreviewer",
    "PanelContext",
    "usePanelContext",
    "type SortableItem",
    "type SortableRowDataContextValue",
    "SortableRowDataContext",
    "useSortableRowItem",
    "type SortablePaneContextValue",
    "SortablePaneContext",
    "useSortablePane"
  ],
  "props": [
    {
      "displayName": "Panel",
      "description": "",
      "props": [
        {
          "name": "className",
          "type": "string | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "alwaysShowCollapsible",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "collapsible",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "isCollapsed",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "isEmpty",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onCollapsedChange",
          "type": "((isCollapsed: boolean) => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onEmptyChange",
          "type": "((isEmpty: boolean) => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "showLabels",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "triggerRef",
          "type": "RefObject<HTMLDivElement> | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelRow",
      "description": "",
      "props": [
        {
          "name": "type",
          "type": "undefined | \"single\" | \"two-columns\" | \"one-label-one-input\" | \"one-label-one-input-one-icon\" | \"one-label-two-input\" | \"one-icon-one-input\" | \"one-input-one-icon\" | \"one-input-two-icon\" | \"two-input-two-icon\" | \"two-input-one-icon\" | \"one-icon-one-input-two-icon\" | \"two-input-one-icon-double-row\"",
          "required": false,
          "defaultValue": "\"single\"",
          "description": "The type of the panel row.\n@description - `single`: `columns`: 1fr | `areas`: \"label\" \"input\" | `rows`: auto minmax(2rem, auto)\n- `two-columns`: `columns`: 1fr 1fr | `areas`: \"label label\" \"left right\" | `rows`: auto minmax(2rem, auto)\n- `one-label-one-input`: `columns`: 8fr 20fr | `areas`: \"label input\" | `rows`: 2rem\n- `one-label-one-input-one-icon`: `columns`: 8fr 20fr 2rem | `areas`: \"label input icon\" | `rows`: 2rem\n- `one-label-two-input`: `columns`: 8fr 1fr 1fr | `areas`: \"label left right\" | `rows`: 2rem\n- `one-icon-one-input`: `columns`: 2rem 1fr | `areas`: \"icon input\" | `rows`: 2rem\n- `one-input-one-icon`: `columns`: 1fr 2rem | `areas`: \"input icon\" | `rows`: 2rem\n- `one-input-two-icon`: `columns`: 1fr 1fr 2rem | `areas`: \"input left icon\" \"input right icon\" | `rows`: 2rem\n- `two-input-two-icon`: `columns`: 1fr 1fr 2rem | `areas`: \"left icon right icon\" | `rows`: 2rem\n- `two-input-one-icon`: `columns`: 2rem 1fr 1fr | `areas`: \"icon left right\" | `rows`: 2rem\n- `one-icon-one-input-two-icon`: `columns`: 2rem 1fr 2rem | `areas`: \"icon input icon\" | `rows`: 2rem\n- `two-input-one-icon-double-row`: `columns`: 1fr 1fr 2rem | `areas`: \"left icon right icon\" | `rows`: 2rem 2rem\n- `one-icon-one-input-two-icon-double-row`: `columns`: 2rem 1fr 2rem | `areas`: \"icon input icon\" | `rows`: 2rem 2rem"
        },
        {
          "name": "active",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "triggerRef",
          "type": "RefObject<HTMLDivElement> | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelLabel",
      "description": "",
      "props": [
        {
          "name": "className",
          "type": "string | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelTitle",
      "description": "",
      "props": [
        {
          "name": "title",
          "type": "string",
          "required": true,
          "description": ""
        },
        {
          "name": "classNames",
          "type": "{ actionWrapper?: string | undefined; container?: string | undefined; title?: string | undefined; titleWrapper?: string | undefined; } | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onHeaderClick",
          "type": "(() => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onTitleClick",
          "type": "(() => void) | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelSortable",
      "description": "",
      "props": [
        {
          "name": "className",
          "type": "string | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "data",
          "type": "SortableItem[]",
          "required": true,
          "description": ""
        },
        {
          "name": "onDrop",
          "type": "(position: \"top\" | \"bottom\" | null, id: string, newIndex: number) => void",
          "required": true,
          "description": ""
        },
        {
          "name": "onSelectedIdChange",
          "type": "(id: string | null) => void",
          "required": true,
          "description": ""
        },
        {
          "name": "selectedId",
          "type": "string | null",
          "required": true,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelSortableRow",
      "description": "",
      "props": [
        {
          "name": "type",
          "type": "undefined | \"single\" | \"two-columns\" | \"one-label-one-input\" | \"one-label-one-input-one-icon\" | \"one-label-two-input\" | \"one-icon-one-input\" | \"one-input-one-icon\" | \"one-input-two-icon\" | \"two-input-two-icon\" | \"two-input-one-icon\" | \"one-icon-one-input-two-icon\" | \"two-input-one-icon-double-row\"",
          "required": false,
          "defaultValue": "\"single\"",
          "description": "The type of the panel row.\n@description - `single`: `columns`: 1fr | `areas`: \"label\" \"input\" | `rows`: auto minmax(2rem, auto)\n- `two-columns`: `columns`: 1fr 1fr | `areas`: \"label label\" \"left right\" | `rows`: auto minmax(2rem, auto)\n- `one-label-one-input`: `columns`: 8fr 20fr | `areas`: \"label input\" | `rows`: 2rem\n- `one-label-one-input-one-icon`: `columns`: 8fr 20fr 2rem | `areas`: \"label input icon\" | `rows`: 2rem\n- `one-label-two-input`: `columns`: 8fr 1fr 1fr | `areas`: \"label left right\" | `rows`: 2rem\n- `one-icon-one-input`: `columns`: 2rem 1fr | `areas`: \"icon input\" | `rows`: 2rem\n- `one-input-one-icon`: `columns`: 1fr 2rem | `areas`: \"input icon\" | `rows`: 2rem\n- `one-input-two-icon`: `columns`: 1fr 1fr 2rem | `areas`: \"input left icon\" \"input right icon\" | `rows`: 2rem\n- `two-input-two-icon`: `columns`: 1fr 1fr 2rem | `areas`: \"left icon right icon\" | `rows`: 2rem\n- `two-input-one-icon`: `columns`: 2rem 1fr 1fr | `areas`: \"icon left right\" | `rows`: 2rem\n- `one-icon-one-input-two-icon`: `columns`: 2rem 1fr 2rem | `areas`: \"icon input icon\" | `rows`: 2rem\n- `two-input-one-icon-double-row`: `columns`: 1fr 1fr 2rem | `areas`: \"left icon right icon\" | `rows`: 2rem 2rem\n- `one-icon-one-input-two-icon-double-row`: `columns`: 2rem 1fr 2rem | `areas`: \"icon input icon\" | `rows`: 2rem 2rem"
        },
        {
          "name": "active",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "triggerRef",
          "type": "RefObject<HTMLDivElement> | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "ref",
          "type": "((instance: HTMLFieldSetElement | null) => void) | RefObject<HTMLFieldSetElement> | null | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelRowLabel",
      "description": "",
      "props": [
        {
          "name": "label",
          "type": "string",
          "required": true,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelRowManyIcon",
      "description": "",
      "props": [
        {
          "name": "icons",
          "type": "PanelRowManyIconItem[]",
          "required": true,
          "description": ""
        },
        {
          "name": "isEditing",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "PanelPreviewer",
      "description": "",
      "props": []
    }
  ],
  "stories": [
    {
      "id": "layouts-panel-sortable--single-item",
      "name": "Single Item",
      "exportName": "SingleItem",
      "description": "",
      "source": "import { Panel, useSortableRowItem } from \"@choice-ui/panel\"\nimport { useEffect, useRef } from \"react\"\n\nexport default function App() {\n\n  const sortableTriggerRefs = useRef<Map<string, HTMLFieldSetElement>>(new Map())\n  const open$ = useObservable<string | null>(null)\n  const selectedId$ = useObservable<string | null>(null)\n\n  // 创建只有一个item的独立数据源\n  const singleItemId = nanoid()\n  const singleItemIndexKey = globalIndexGenerator.keyStart()\n\n  const singleSortData$ = useObservable([\n    {\n      id: singleItemId,\n      indexKey: singleItemIndexKey,\n    },\n  ])\n\n  const singleItemsData$ = useObservable({\n    [singleItemId]: {\n      visible: true,\n      value: \"Single Item\",\n    },\n  })\n\n  const handleAdd = useEventCallback(() => {\n    batch(() => {\n      const items = singleSortData$.peek()\n      const newId = nanoid()\n\n      let newIndexKey\n      if (items.length === 0) {\n        newIndexKey = globalIndexGenerator.keyStart()\n      } else {\n        const lastItem = items[items.length - 1]\n        newIndexKey = globalIndexGenerator.keyAfter(lastItem.indexKey)\n      }\n\n      updateKeysList(newIndexKey)\n\n      const newSortItem = {\n        id: newId,\n        indexKey: newIndexKey,\n      }\n\n      const newItemData = {\n        visible: true,\n        value: `Item ${items.length + 1}`,\n      }\n\n      singleSortData$.set([...items, newSortItem])\n\n      singleItemsData$.set({\n        ...singleItemsData$.peek(),\n        [newId]: newItemData,\n      })\n    })\n  })\n\n  const handleRemove = useEventCallback((id: string) => {\n    batch(() => {\n      const sortItems = singleSortData$.peek()\n      const itemToRemove = sortItems.find((item) => item.id === id)\n      if (!itemToRemove) return\n\n      const newSortItems = sortItems.filter((item) => item.id !== id)\n      singleSortData$.set(newSortItems)\n\n      const itemsData = singleItemsData$.peek()\n      const newItemsData = { ...itemsData }\n      delete newItemsData[id]\n      singleItemsData$.set(newItemsData)\n\n      selectedId$.set(null)\n    })\n  })\n\n  const handleVisible = useEventCallback((id: string, visible: boolean) => {\n    batch(() => {\n      const itemsData = singleItemsData$.peek()\n\n      if (itemsData[id]) {\n        singleItemsData$.set({\n          ...itemsData,\n          [id]: {\n            ...itemsData[id],\n            visible,\n          },\n        })\n\n        selectedId$.set(null)\n      }\n    })\n  })\n\n  const handleSelect = useEventCallback((id: string | null) => {\n    selectedId$.set(id)\n  })\n\n  const handleDrop = useEventCallback(\n    (position: \"top\" | \"bottom\" | null, id: string, newIndex: number) => {\n      // 单个item场景下的拖拽处理（虽然不会触发，但保持接口一致）\n      console.log(\"Drop handler called for single item scenario\")\n    },\n  )\n\n  // 键盘删除\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      const id = selectedId$.get()\n      if ((e.key === \"Delete\" || e.key === \"Backspace\") && id) {\n        handleRemove(id)\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => {\n      window.removeEventListener(\"keydown\", handleKeyDown)\n    }\n  }, [handleRemove, selectedId$])\n\n  const SingleItemSortableRowContent = observer(function SingleItemSortableRowContent() {\n    const item = useSortableRowItem<{ id: string; indexKey: string }>()\n    const itemsData = use$(singleItemsData$)\n\n    // 获取当前行的具体显示数据\n    const currentItemDisplayData = itemsData[item.id]\n    const visible = currentItemDisplayData ? currentItemDisplayData.visible : true\n    const valueToDisplay = currentItemDisplayData ? currentItemDisplayData.value : item.indexKey\n\n    return (\n      <Panel.SortableRow\n        ref={(el) => {\n          if (el) {\n            sortableTriggerRefs.current.set(item.id, el)\n          }\n        }}\n        type=\"one-icon-one-input-two-icon\"\n        onClick={(e) => {\n          e.stopPropagation()\n          handleSelect(item.id)\n        }}\n      >\n        <IconButton\n          active={open$.get() === item.id}\n          variant=\"highlight\"\n          className={tcx(\"[grid-area:icon-1]\", !visible && \"text-disabled-foreground\")}\n          tooltip={{ content: \"Effect drop shadow-sm\" }}\n          onClick={(e) => {\n            e.stopPropagation()\n          }}\n          onMouseDown={(e) => {\n            e.stopPropagation()\n            selectedId$.set(null)\n            if (open$.get() !== item.id) {\n              React.startTransition(() => {\n                open$.set(item.id)\n              })\n            } else {\n              open$.set(null)\n            }\n          }}\n        >\n          <EffectDropShadow />\n        </IconButton>\n\n        <Select\n          matchTriggerWidth\n          value={item.indexKey}\n        >\n          <Select.Trigger\n            className={tcx(\n              !visible && \"text-disabled-foreground\",\n              \"group-data-[selected=true]/sortable-row:border-selected-boundary [grid-area:input]\",\n            )}\n          >\n            <span className=\"flex-1 truncate\">{valueToDisplay}</span>\n          </Select.Trigger>\n          <Select.Content>\n            <Select.Item value={item.indexKey}>{valueToDisplay}</Select.Item>\n          </Select.Content>\n        </Select>\n\n        <IconButton\n          className=\"[grid-area:icon-2]\"\n          tooltip={{ content: \"Visible\" }}\n          onClick={(e) => {\n            e.stopPropagation()\n            handleVisible(item.id, !visible)\n          }}\n          onMouseDown={(e) => {\n            e.stopPropagation()\n          }}\n        >\n          {visible ? <Visible /> : <Hidden />}\n        </IconButton>\n\n        <IconButton\n          className=\"[grid-area:icon-3]\"\n          tooltip={{ content: \"Delete\" }}\n          onClick={(e) => {\n            e.stopPropagation()\n            handleRemove(item.id)\n          }}\n          onMouseDown={(e) => {\n            e.stopPropagation()\n          }}\n        >\n          <DeleteSmall />\n        </IconButton>\n      </Panel.SortableRow>\n    )\n  })\n\n  const SingleItemSortable = observer(function SingleItemSortable() {\n    const sortData = use$(singleSortData$)\n\n    return (\n      <Panel.Sortable\n        data={sortData}\n        selectedId={selectedId$.get()}\n        onDrop={handleDrop}\n        onSelectedIdChange={(id) => selectedId$.set(id)}\n      >\n        <SingleItemSortableRowContent />\n      </Panel.Sortable>\n    )\n  })\n\n  return (\n    <>\n      <AllotmentContainer>\n        <Panel>\n          <Panel.Title title=\"Single Item (No Drag Handle)\">\n            <IconButton\n              onClick={handleAdd}\n              tooltip={{ content: \"Add item\" }}\n            >\n              <AddSmall />\n            </IconButton>\n          </Panel.Title>\n\n          <SingleItemSortable />\n        </Panel>\n      </AllotmentContainer>\n\n      <SortablePopover\n        triggerRefs={sortableTriggerRefs}\n        open$={open$}\n      />\n    </>\n  )\n\n}"
    },
    {
      "id": "layouts-panel-sortable--basic",
      "name": "Basic",
      "exportName": "Basic",
      "description": "",
      "source": "import { Panel } from \"@choice-ui/panel\"\nimport { useEffect, useRef } from \"react\"\n\nexport default function App() {\n\n  const sortableTriggerRefs = useRef<Map<string, HTMLFieldSetElement>>(new Map())\n  const open$ = useObservable<string | null>(null)\n  const selectedId$ = useObservable<string | null>(null)\n\n  const handleAdd = useEventCallback(() => {\n    batch(() => {\n      const items = SORT_DATA$.peek()\n      const newId = nanoid()\n\n      let newIndexKey\n      if (items.length === 0) {\n        newIndexKey = globalIndexGenerator.keyStart()\n      } else {\n        const lastItem = items[items.length - 1]\n        newIndexKey = globalIndexGenerator.keyAfter(lastItem.indexKey)\n      }\n\n      updateKeysList(newIndexKey)\n\n      const newSortItem = {\n        id: newId,\n        indexKey: newIndexKey,\n      }\n\n      const newItemData = {\n        visible: true,\n        value: faker.helpers.arrayElement([\n          \"option-1\",\n          \"option-2\",\n          \"option-3\",\n          \"option-4\",\n          \"option-5\",\n          \"option-6\",\n          \"option-7\",\n          \"option-8\",\n          \"option-9\",\n        ]),\n      }\n\n      SORT_DATA$.set([...items, newSortItem])\n\n      ITEMS_DATA$.set({\n        ...ITEMS_DATA$.peek(),\n        [newId]: newItemData,\n      })\n    })\n  })\n\n  const handleRemove = useEventCallback((id: string) => {\n    batch(() => {\n      const sortItems = SORT_DATA$.peek()\n      const itemToRemove = sortItems.find((item) => item.id === id)\n      if (!itemToRemove) return\n\n      const newSortItems = sortItems.filter((item) => item.id !== id)\n      SORT_DATA$.set(newSortItems)\n\n      const keyIndex = indexKeysList.indexOf(itemToRemove.indexKey)\n      if (keyIndex !== -1) {\n        indexKeysList.splice(keyIndex, 1)\n        globalIndexGenerator.updateList(indexKeysList)\n      }\n\n      const itemsData = ITEMS_DATA$.peek()\n      const newItemsData = { ...itemsData }\n      delete newItemsData[id]\n      ITEMS_DATA$.set(newItemsData)\n\n      selectedId$.set(null)\n    })\n  })\n\n  const handleVisible = useEventCallback((id: string, visible: boolean) => {\n    batch(() => {\n      const itemsData = ITEMS_DATA$.peek()\n\n      if (itemsData[id]) {\n        ITEMS_DATA$.set({\n          ...itemsData,\n          [id]: {\n            ...itemsData[id],\n            visible,\n          },\n        })\n\n        selectedId$.set(null)\n      }\n    })\n  })\n\n  const handleSelect = useEventCallback((id: string | null) => {\n    selectedId$.set(id)\n  })\n\n  const handleDrop = useEventCallback(\n    (position: \"top\" | \"bottom\" | null, id: string, newIndex: number) => {\n      batch(() => {\n        const sortItems = SORT_DATA$.peek()\n        const indexList = sortItems.map((item) => item.indexKey)\n\n        const itemToMove = sortItems.find((item) => item.id === id)\n        if (!itemToMove) return\n\n        // 更新索引键列表\n        globalIndexGenerator.updateList(indexList)\n\n        let isStart = false\n        let isEnd = false\n\n        if (newIndex === 0 && position === \"top\") {\n          isStart = true\n        }\n\n        if (newIndex === sortItems.length - 1 && position === \"bottom\") {\n          isEnd = true\n        }\n\n        let newIndexKey: string | undefined\n        if (isStart) {\n          newIndexKey = globalIndexGenerator.keyStart()\n        } else if (isEnd) {\n          newIndexKey = globalIndexGenerator.keyEnd()\n        } else {\n          if (position === \"top\") {\n            newIndexKey = globalIndexGenerator.keyBefore(sortItems[newIndex - 1].indexKey)\n          } else {\n            newIndexKey = globalIndexGenerator.keyAfter(sortItems[newIndex].indexKey)\n          }\n        }\n\n        if (!newIndexKey) return\n\n        // 更新排序数据\n        const newSortItems = sortItems.map((item) =>\n          item.id === id ? { ...item, indexKey: newIndexKey } : item,\n        )\n\n        // 重新排序\n        newSortItems.sort((a, b) => sortByIndex(a, b))\n\n        // 更新索引键列表\n        SORT_DATA$.set(newSortItems)\n      })\n    },\n  )\n\n  // 键盘删除\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      const id = selectedId$.get()\n      if ((e.key === \"Delete\" || e.key === \"Backspace\") && id) {\n        handleRemove(id)\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => {\n      window.removeEventListener(\"keydown\", handleKeyDown)\n    }\n  }, [handleRemove, selectedId$])\n\n  return (\n    <>\n      <AllotmentContainer>\n        <Panel>\n          <Panel.Title title=\"Sortable\">\n            <IconButton\n              onClick={handleAdd}\n              tooltip={{ content: \"Add fill\" }}\n            >\n              <AddSmall />\n            </IconButton>\n          </Panel.Title>\n\n          <Sortable\n            sortableTriggerRefs={sortableTriggerRefs}\n            open$={open$}\n            selectedId$={selectedId$}\n            onSelect={handleSelect}\n            onVisible={handleVisible}\n            onRemove={handleRemove}\n            onDrop={handleDrop}\n          />\n        </Panel>\n      </AllotmentContainer>\n\n      <SortablePopover\n        triggerRefs={sortableTriggerRefs}\n        open$={open$}\n      />\n    </>\n  )\n\n}"
    }
  ]
}