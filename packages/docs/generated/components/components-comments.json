{
  "slug": "components/comments",
  "title": "Comments",
  "package": {
    "name": "@choice-ui/comments",
    "version": "0.0.4",
    "description": "A rich text comment system component with threading, mentions, and emoji support",
    "dependencies": {
      "@choice-ui/avatar": "workspace:*",
      "@choice-ui/button": "workspace:*",
      "@choice-ui/shared": "workspace:*",
      "@choice-ui/dialog": "workspace:*",
      "@choice-ui/dropdown": "workspace:*",
      "@choice-ui/emoji-picker": "workspace:*",
      "@choice-ui/icon-button": "workspace:*",
      "@choiceform/icons-react": "^1.3.8",
      "@choice-ui/menus": "workspace:*",
      "@choice-ui/picture-preview": "workspace:*",
      "@choice-ui/popover": "workspace:*",
      "@choice-ui/scroll-area": "workspace:*",
      "@choice-ui/tooltip": "workspace:*",
      "@date-fns/tz": "^1.2.0",
      "@floating-ui/react": "0.27.15",
      "@legendapp/state": "v3.0.0-beta.26",
      "date-fns": "^4.1.0",
      "is-hotkey": "^0.2.0",
      "nanoid": "^5.1.6",
      "slate": "^0.120.0",
      "slate-history": "^0.113.1",
      "slate-react": "^0.120.0",
      "usehooks-ts": "^3.1.0"
    },
    "peerDependencies": {
      "react": ">=18.0.0",
      "react-dom": ">=18.0.0"
    }
  },
  "exports": [
    "Comments",
    "type CommentInputProps",
    "CommentInput",
    "type CustomEditor",
    "type ExtendedRenderElement",
    "type ParagraphElement",
    "type StructuredData",
    "type MentionElement",
    "type Attachment",
    "type ImageElement",
    "type ListItemElement",
    "type NumberedListElement",
    "type BulletedListElement",
    "type CustomElement",
    "type CustomText",
    "CommentItem",
    "type CommentItemProps",
    "comments$",
    "sortedComments$",
    "allComments$",
    "commentsService",
    "useCommentsState",
    "type User",
    "type Reaction",
    "type SubmittedCommentData",
    "type InputDefaultText",
    "type ItemDefaultText",
    "type DefaultText"
  ],
  "props": [
    {
      "displayName": "CommentsComponent",
      "description": "",
      "props": [
        {
          "name": "author",
          "type": "User",
          "required": true,
          "description": ""
        },
        {
          "name": "className",
          "type": "string | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "defaultText",
          "type": "DefaultText | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "fetchMoreComments",
          "type": "((page: number, pageSize: number) => Promise<{ comments: SubmittedCommentData[]; totalCount: number; }>) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "initialComments",
          "type": "SubmittedCommentData[] | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "totalCount",
          "type": "number | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "users",
          "type": "User[] | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "CommentInput",
      "description": "",
      "props": [
        {
          "name": "className",
          "type": "string | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "defaultText",
          "type": "InputDefaultText | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "initialValue",
          "type": "Descendant[] | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "maxUploadFiles",
          "type": "number | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onCancel",
          "type": "(() => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onChange",
          "type": "((value: Descendant[]) => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onSubmit",
          "type": "((value: Descendant[]) => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "onTypingChange",
          "type": "((isTyping: boolean) => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "placeholder",
          "type": "string | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "users",
          "type": "User[] | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "variant",
          "type": "undefined | \"default\" | \"solid\"",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "CommentItem",
      "description": "",
      "props": [
        {
          "name": "author",
          "type": "User",
          "required": true,
          "description": ""
        },
        {
          "name": "className",
          "type": "string | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "created_at",
          "type": "Date",
          "required": true,
          "description": ""
        },
        {
          "name": "defaultText",
          "type": "ItemDefaultText | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "handleOnDelete",
          "type": "(() => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "handleOnEdit",
          "type": "(() => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "handleOnImageClick",
          "type": "((attachmentIndex?: number | undefined) => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "handleOnReactionClick",
          "type": "((reaction: GroupedReaction) => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "handleOnReactionPopoverClick",
          "type": "(() => void) | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "locale",
          "type": "undefined | \"zh-cn\" | \"en-us\"",
          "required": false,
          "description": ""
        },
        {
          "name": "message_meta",
          "type": "Descendant[]",
          "required": true,
          "description": ""
        },
        {
          "name": "reactionAnchorRef",
          "type": "RefObject<HTMLButtonElement> | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "reactions",
          "type": "Reaction[] | null",
          "required": true,
          "description": ""
        },
        {
          "name": "reactionsPopoverIsOpen",
          "type": "boolean | undefined",
          "required": false,
          "description": ""
        },
        {
          "name": "ref",
          "type": "((instance: HTMLDivElement | null) => void) | RefObject<HTMLDivElement> | null | undefined",
          "required": false,
          "description": ""
        }
      ]
    },
    {
      "displayName": "startEditing",
      "description": "",
      "props": []
    },
    {
      "displayName": "setEditingContent",
      "description": "",
      "props": []
    },
    {
      "displayName": "deleteComment",
      "description": "",
      "props": []
    },
    {
      "displayName": "loadMoreComments",
      "description": "",
      "props": []
    }
  ],
  "stories": [
    {
      "id": "components-comments--basic",
      "name": "Basic",
      "exportName": "Basic",
      "description": "",
      "source": "import { Comments } from \"@choice-ui/comments\"\nimport { useState, useEffect, useRef } from \"react\"\n\nexport default function App() {\n\n  const [openDialog, setOpenDialog] = useState(false)\n\n  const [initialComments, setInitialComments] = useState<SubmittedCommentData[]>([])\n\n  const [totalCount, setTotalCount] = useState(0)\n\n  // 当前已加载的评论 (供调试显示用)\n  const [loadedComments, setLoadedComments] = useState<SubmittedCommentData[]>([])\n\n  // 使用ref跟踪上一次的评论状态，避免不必要的更新\n  const lastCommentsHashRef = useRef<string>(\"\")\n\n  // 重置状态，确保每次都从头开始\n  useEffect(() => {\n    resetCommentState()\n\n    // 使用正确的方式监听Legend State的变化\n    // 直接使用observable的get方法获取状态并计算唯一标识\n    const updateCommentsIfChanged = () => {\n      const state = comments$.get()\n      const commentsList = state.order.map((id) => state.byId[id])\n      const commentsHash = JSON.stringify(commentsList.map((c) => c.uuid))\n\n      if (commentsHash !== lastCommentsHashRef.current) {\n        lastCommentsHashRef.current = commentsHash\n        setLoadedComments(commentsList)\n      }\n    }\n\n    // 使用setInterval但间隔更长，减少性能问题\n    const intervalId = setInterval(updateCommentsIfChanged, 500)\n\n    // 立即执行一次\n    updateCommentsIfChanged()\n\n    return () => {\n      clearInterval(intervalId)\n      resetCommentState()\n    }\n  }, [])\n\n  // 已加载评论的调试视图\n  const loadedCommentsDebug = (\n    <div className=\"text-secondary-foreground p-2\">\n      <h3 className=\"font-strong mb-2 text-xs\">已加载评论 ({loadedComments.length})</h3>\n      {loadedComments.length === 0 ? (\n        <p className=\"text-xs text-gray-500 italic\">无评论</p>\n      ) : (\n        <div className=\"space-y-4\">\n          {loadedComments.map((item, i) => (\n            <div\n              key={item.uuid}\n              className=\"border-l-2 border-blue-400 pl-2 text-xs\"\n            >\n              <p>\n                <strong>评论 {item.uuid}</strong> - 页码: {item.page_id} - {item.author.name} 于{\" \"}\n                {item.created_at.toLocaleString()}\n              </p>\n              <p className=\"mt-1 text-xs text-gray-600\">{item.message}</p>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  )\n\n  // 实时状态监视器\n  const stateMonitor = (\n    <div className=\"bg-gray-900 p-2 text-white\">\n      <h3 className=\"font-strong mb-2 text-xs\">状态监控</h3>\n      <div className=\"space-y-2\">\n        <div>\n          <p className=\"text-xs text-gray-400\">加载的评论数: {loadedComments.length}</p>\n          <p className=\"text-xs text-gray-400\">总评论数: {totalCount}</p>\n          <p className=\"text-xs text-gray-400\">\n            分页信息: 当前页 {comments$.pagination.get().currentPage},\n            {comments$.pagination.get().hasMore ? \"有更早评论\" : \"无更早评论\"}\n          </p>\n          <p className=\"text-xs text-gray-400\">\n            加载状态: {comments$.pagination.get().isLoading ? \"加载中\" : \"空闲\"}\n          </p>\n        </div>\n      </div>\n    </div>\n  )\n\n  // 调试工具\n  const debugTools = (\n    <div className=\"mt-4 flex gap-2\">\n      <button\n        className=\"rounded bg-red-500 px-2 py-1 text-xs text-white\"\n        onClick={() => {\n          resetCommentState()\n          setLoadedComments([])\n        }}\n      >\n        重置状态\n      </button>\n\n      <button\n        className=\"rounded bg-blue-500 px-2 py-1 text-xs text-white\"\n        onClick={() => {\n          // 直接使用 comments$ observable 来创建评论\n          const currentState = comments$.get()\n          const newId = `comment-${Date.now()}`\n          const newComment: SubmittedCommentData = {\n            uuid: newId,\n            author: mockUsers[0],\n            created_at: new Date(),\n            deleted_at: null,\n            is_deleted: false,\n            message: faker.lorem.sentence(),\n            message_meta: [\n              {\n                type: \"paragraph\",\n                children: [{ text: faker.lorem.sentence() }],\n              },\n            ],\n            order_id: null,\n            page_id: null,\n            reactions: null,\n            resolved_at: null,\n            updated_at: new Date(),\n          }\n\n          comments$.set({\n            ...currentState,\n            byId: {\n              ...currentState.byId,\n              [newId]: newComment,\n            },\n            order: [...currentState.order, newId],\n          })\n        }}\n      >\n        添加新评论\n      </button>\n    </div>\n  )\n\n  const isEmpty = comments$.get().order.length === 0\n\n  return (\n    <>\n      <Dialog\n        open={true}\n        onOpenChange={setOpenDialog}\n        className=\"overflow-hidden\"\n        draggable\n      >\n        {isEmpty ? null : <Dialog.Header title=\"评论组件 - 分页懒加载示例\" />}\n        <Dialog.Content className={tcx(isEmpty ? \"w-[296px]\" : \"w-[360px]\")}>\n          <Comments\n            className=\"flex max-h-[512px] flex-col overflow-hidden\"\n            initialComments={initialComments}\n            totalCount={totalCount}\n            fetchMoreComments={fetchComments}\n            users={mockUsers}\n            author={mockUsers[0]}\n          />\n        </Dialog.Content>\n      </Dialog>\n\n      <div className=\"grid h-[80vh] w-[80vw] grid-cols-2 gap-2\">\n        {loadedCommentsDebug}\n        <div className=\"space-y-4\">\n          {stateMonitor}\n          {debugTools}\n        </div>\n      </div>\n    </>\n  )\n\n}"
    }
  ],
  "tags": [
    "experimental"
  ]
}